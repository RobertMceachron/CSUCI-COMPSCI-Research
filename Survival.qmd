---
format: 
  html:
    df-print: paged
    toc: true
    toc-expand: 4
    toc-location: left
    embed-resources: true
execute:
  warning: false
  message: false
editor: 
  markdown: 
    wrap: 72
knitr:
  opts_chunk:
    message: false
    warning: false
---

# Survival Analysis Writeup

## Data

### Data Initialization

```{r}
library(survival)
library(survminer) 
library(ggsurvfit)
library(timereg)
library(tidyverse)
library(lubridate)
library(gtsummary)
library(tidycmprsk)

orig_data <- read.csv("clean_reorder.csv")
```

### Data Cleaning

Removes all outliers as discovered by Monique in her logistic_code.r
file.

```{r}
exclude_ids <- c(87342, 88622, 115940, 116400, 119260, 119666, 
                 123410, 123763, 125801, 134550, 136923, 137741, 
                 148889, 166141, 170839, 171347, 180884, 183053, 
                 186289, 186831, 187203, 189667, 190224, 192427, 
                 196323, 197088, 198042, 199769, 202662, 202991, 
                 203268, 206221, 208002, 211466, 213204, 218582, 
                 218627, 219283, 219636, 220135, 224641, 227349, 
                 232735, 236539, 249151, 252130, 252367, 263242)

# Filter the data frame
excluded_data <- orig_data %>%
                 filter(!Student %in% exclude_ids)

# Creates our new data frame
recoded_data <- excluded_data
```

### Data Re-Coding

Now we are working with excluded data, we are going to re-code the
values and set them up as factors.

```{r}
# Re-codes Values of Male/Female to Binary
recoded_data$Gender_Binary <- as.character(recode(recoded_data$Gender,
                                "Man" = "0",
                                "Woman" = "1",
                                .default = "1"))
  
# Re-codes Values of Graduation to Binary
recoded_data$Did_Graduate_Binary <- ifelse(recoded_data$Did_Graduate == recoded_data$Term_Code, 1, 0)

# Recodes Binary Variables as Factors
recoded_data$Is_Hispanic <- factor(recoded_data$Is_Hispanic)
recoded_data$Gender_Binary <- factor(recoded_data$Gender_Binary)
recoded_data$Is_Transfer <- factor(recoded_data$Is_Transfer)
recoded_data$Lived_On_Campus <- factor(recoded_data$Is_Transfer)
recoded_data$Num_Tutoring_Visits <- as.numeric(recoded_data$Num_Tutoring_Visits) 

# Adds Start/Stop Sequences
recoded_data <- recoded_data %>%
  group_by(Student) %>% 
  mutate(
    Start = seq(0, n()-1),
    Stop = seq(1, n())
  )

# Creates DataFrame with only Necessary Columns
overall_data <- select(recoded_data, Student, Is_Hispanic, Is_Transfer, Lived_On_Campus, Num_Tutoring_Visits, Gender_Binary, Did_Graduate_Binary, Start, Stop)

# Creates DataFrames with either Home or Transfer Students
home_data <- overall_data[overall_data$Is_Transfer == 0, ]
transfer_data <- overall_data[overall_data$Is_Transfer == 1, ]
```

## Analyses

### Survival Analysis (Overall)

This analysis will include all predictors.

#### Code

```{r}
# Cox Proportional Hazards Model
overall_cox <- coxph(Surv(time = Start, time2 = Stop, event = Did_Graduate_Binary) 
                  ~  Num_Tutoring_Visits + Is_Hispanic + Gender_Binary + Lived_On_Campus + Is_Transfer, data = overall_data) 

# Creates a Table with 
overall_cox |> 
  tbl_regression(exp = TRUE)
  summary(overall_cox) 

# Checking the Proportional Hazards Assumption
PHA <- cox.zph(overall_cox, global = FALSE)

# View the results
print(PHA)
plot(PHA)

# All Variables Fit
survival_fit <- survfit(overall_cox)
ggsurvplot(survival_fit, data = overall_data, conf.int = TRUE, color = "#2E9FDF",
          xlab = "Time", ylab = "Survival Probability",
          title = "Survival Curves from Cox Proportional Hazards Model")
```

#### Results

The results indicate that

#### Survival Analysis (Overall without Transfer)

This analysis will include all predictors without transfer.

#### Survival Analysis (Home Students)

This analysis will include all predictors without transfer and only be
ran on students who started their education at CSUCI.

#### Survival Analysis (Transfer Students)

This analysis will include all predictors without transfer and only be
ran on students who transferred to CSUCI.
